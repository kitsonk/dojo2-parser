{"version":3,"file":"ReadableStreamReader.js","sourceRoot":"","sources":["streams/ReadableStreamReader.ts"],"names":["isReadableStreamReader","ReadableStreamReader","ReadableStreamReader.constructor","ReadableStreamReader.closed","ReadableStreamReader.cancel","ReadableStreamReader.read","ReadableStreamReader.releaseLock","ReadableStreamReader.release","ReadableStreamReader.resolveReadRequest"],"mappings":"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","sourcesContent":["import Promise from '../Promise';\nimport ReadableStream, { State } from './ReadableStream';\n\nexport interface ReadRequest<T> {\n\tpromise: Promise<ReadResult<T>>;\n\tresolve: (value: ReadResult<T>) => void;\n\treject: (reason: any) => void;\n}\n\nexport interface ReadResult<T> {\n\tvalue: T;\n\tdone: boolean;\n}\n\nexport function isReadableStreamReader<T>(readableStreamReader: ReadableStreamReader<T>): boolean {\n\treturn Object.prototype.hasOwnProperty.call(readableStreamReader, '_ownerReadableStream');\n}\n\nexport default class ReadableStreamReader<T> {\n\tget closed(): Promise<void> {\n\t\treturn this._closedPromise;\n\t}\n\n\tprivate _closedPromise: Promise<void>;\n\tprivate _ownerReadableStream: ReadableStream<T>;\n\tprivate _storedError: Error;\n\tprivate _readRequests: ReadRequest<T>[];\n\tprivate _resolveClosedPromise: () => void;\n\tprivate _rejectClosedPromise: (error: Error) => void;\n\n\tstate: State;\n\n\tconstructor(stream: ReadableStream<T>) {\n\t\tif (!stream.readable) {\n\t\t\tthrow new TypeError('3.4.3-1: stream must be a ReadableStream');\n\t\t}\n\n\t\tif (stream.locked) {\n\t\t\tthrow new TypeError('3.4.3-2: stream cannot be locked');\n\t\t}\n\n\t\tstream.reader = this;\n\t\tthis._ownerReadableStream = stream;\n\t\tthis.state = State.Readable;\n\t\tthis._storedError = undefined;\n\t\tthis._readRequests = [];\n\t\tthis._closedPromise = new Promise<void>((resolve, reject) => {\n\t\t\tthis._resolveClosedPromise = resolve;\n\t\t\tthis._rejectClosedPromise = reject;\n\t\t});\n\t}\n\n\tcancel(reason: string): Promise<void> {\n\t\tif (!isReadableStreamReader(this)) {\n\t\t\treturn Promise.reject(new TypeError('3.4.4.2-1: Must be a ReadableStreamReader instance'));\n\t\t}\n\n\t\tif (this.state === State.Closed) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tif (this.state === State.Errored) {\n\t\t\treturn Promise.reject(this._storedError);\n\t\t}\n\n\t\tif (this._ownerReadableStream && this._ownerReadableStream.state === State.Readable) {\n\t\t\treturn this._ownerReadableStream.cancel(reason);\n\t\t}\n\n\t\t// 3.4.4.2-4,5 - the spec calls for this to throw an error. We have changed it to reject instead\n\t\treturn Promise.reject(new TypeError('3.4.4.2-4,5: Cannot cancel ReadableStreamReader'));\n\t}\n\n\t/**\n\t * This method also incorporates the readFromReadableStreamReader from 3.5.12.\n\t * @alias ReadFromReadableStreamReader\n\t * @returns {Promise<ReadResult<T>>}\n\t */\n\tread(): Promise<ReadResult<T>> {\n\t\tif (!isReadableStreamReader(this)) {\n\t\t\treturn Promise.reject<ReadResult<T>>(new TypeError('3.4.4.3-1: Must be a ReadableStreamReader instance'));\n\t\t}\n\n\t\tif (this.state === State.Closed) {\n\t\t\treturn Promise.resolve({\n\t\t\t\tvalue: undefined,\n\t\t\t\tdone: true\n\t\t\t});\n\t\t}\n\n\t\tif (this.state === State.Errored) {\n\t\t\treturn Promise.reject<ReadResult<T>>(new TypeError('3.5.12-2: reader state is Errored'));\n\t\t}\n\n\t\tconst stream = this._ownerReadableStream;\n\t\tif (!stream || stream.state !== State.Readable) {\n\t\t\tthrow new TypeError('3.5.12-3,4: Stream must exist and be readable');\n\t\t}\n\n\t\tconst queue = stream.queue;\n\t\tif (queue.length > 0) {\n\t\t\tconst chunk = queue.dequeue();\n\t\t\tif (stream.closeRequested && !queue.length) {\n\t\t\t\tstream.close();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstream.pull();\n\t\t\t}\n\t\t\treturn Promise.resolve({\n\t\t\t\tvalue: chunk,\n\t\t\t\tdone: false\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tconst readPromise = new Promise<ReadResult<T>>((resolve, reject) => {\n\t\t\t\tthis._readRequests.push({\n\t\t\t\t\tpromise: readPromise,\n\t\t\t\t\tresolve: resolve,\n\t\t\t\t\treject: reject\n\t\t\t\t});\n\t\t\t\tstream.pull();\n\t\t\t});\n\n\t\t\treturn readPromise;\n\t\t}\n\t}\n\n\t/**\n\t * release a reader's lock on the corresponding stream.\n\t * 3.4.4.4. releaseLock()\n\t */\n\treleaseLock(): void {\n\t\tif (!isReadableStreamReader(this)) {\n\t\t\tthrow new TypeError('3.4.4.4-1: Must be a ReadableStreamrteader isntance');\n\t\t}\n\n\t\tif (!this._ownerReadableStream) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._readRequests.length) {\n\t\t\tthrow new TypeError('3.4.4.4-3: Tried to release a reader lock when that reader has pending read calls un-settled');\n\t\t}\n\n\t\tthis.release();\n\t}\n\n\t/**\n\t * 3.5.13. ReleaseReadableStreamReader ( reader )\n\t * alias ReleaseReadableStreamReader\n\t */\n\trelease(): void {\n\t\tlet request: any;\n\t\tif (this._ownerReadableStream.state === State.Errored) {\n\t\t\tthis.state = State.Errored;\n\n\t\t\tconst e = this._ownerReadableStream.storedError;\n\t\t\tthis._storedError = e;\n\t\t\tthis._rejectClosedPromise(e);\n\n\t\t\tfor (request of this._readRequests) {\n\t\t\t\trequest.reject(e);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.state = State.Closed;\n\t\t\tthis._resolveClosedPromise();\n\t\t\tfor (request of this._readRequests) {\n\t\t\t\trequest.resolve({\n\t\t\t\t\tvalue: undefined,\n\t\t\t\t\tdone: true\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tthis._readRequests = [];\n\t\tthis._ownerReadableStream.reader = undefined;\n\t\tthis._ownerReadableStream = undefined;\n\t}\n\n\t/**\n\t * Resolves a pending read request, if any, with the provided chunk.\n\t * @param chunk\n\t * @return boolean True if a read request was resolved.\n\t */\n\tresolveReadRequest(chunk: T): boolean {\n\t\tif (this._readRequests.length > 0) {\n\t\t\tthis._readRequests.shift().resolve({\n\t\t\t\tvalue: chunk,\n\t\t\t\tdone: false\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n}\n"]}