{"version":3,"file":"TransformStream.js","sourceRoot":"","sources":["streams/TransformStream.ts"],"names":["TransformStream","TransformStream.constructor","TransformStream.constructor.maybeDoTransform","TransformStream.constructor.transformDone","TransformStream.constructor.abort","TransformStream.constructor.start","TransformStream.constructor.write","TransformStream.constructor.close","TransformStream.constructor.pull","TransformStream.constructor.cancel"],"mappings":"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","sourcesContent":["import { Strategy } from './interfaces';\nimport Promise from '../Promise';\nimport ReadableStream, { Source } from './ReadableStream';\nimport ReadableStreamController from './ReadableStreamController';\nimport WritableStream, { Sink } from './WritableStream';\n\nexport interface Transform<R, W> {\n\ttransform(chunk: W, enqueueInReadable: (chunk: R) => void, transformDone: () => void): void;\n\tflush(enqueue: Function, close: Function): void;\n\twritableStrategy: Strategy<W>;\n\treadableStrategy: Strategy<R>;\n}\n\nexport default class TransformStream<R, W> {\n\treadable: ReadableStream<R>;\n\twritable: WritableStream<W>;\n\n\tconstructor(transformer: Transform<R, W>) {\n\t\tlet writeChunk: W;\n\t\tlet writeDone: () => void;\n\t\tlet errorWritable: (error?: any) => void;\n\t\tlet transforming = false;\n\t\tlet chunkWrittenButNotYetTransformed = false;\n\t\tlet enqueueInReadable: () => void;\n\t\tlet closeReadable: (error?: any) => void;\n\t\tlet errorReadable: (error?: any) => void;\n\n\t\tfunction maybeDoTransform() {\n\t\t\tif (!transforming) {\n\t\t\t\ttransforming = true;\n\t\t\t\ttry {\n\t\t\t\t\ttransformer.transform(writeChunk, enqueueInReadable, transformDone);\n\t\t\t\t\twriteChunk = undefined;\n\t\t\t\t\tchunkWrittenButNotYetTransformed = false;\n\t\t\t\t} catch (e) {\n\t\t\t\t\ttransforming = false;\n\t\t\t\t\terrorWritable(e);\n\t\t\t\t\terrorReadable(e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction transformDone() {\n\t\t\ttransforming = false;\n\t\t\twriteDone();\n\t\t}\n\n\t\tthis.writable = new WritableStream<W>(<Sink <W>> {\n\t\t\tabort(): Promise<void> {\n\t\t\t\treturn Promise.resolve();\n\t\t\t},\n\n\t\t\tstart(error: (error?: any) => void) {\n\t\t\t\terrorWritable = error;\n\t\t\t\treturn Promise.resolve();\n\t\t\t},\n\n\t\t\twrite(chunk: W) {\n\t\t\t\twriteChunk = chunk;\n\t\t\t\tchunkWrittenButNotYetTransformed = true;\n\t\t\t\tconst p = new Promise<void>(function (resolve) {\n\t\t\t\t\twriteDone = resolve;\n\t\t\t\t});\n\t\t\t\tmaybeDoTransform();\n\t\t\t\treturn p;\n\t\t\t},\n\n\t\t\tclose(): Promise<void> {\n\t\t\t\ttry {\n\t\t\t\t\ttransformer.flush(enqueueInReadable, closeReadable);\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t} catch (e) {\n\t\t\t\t\terrorWritable(e);\n\t\t\t\t\terrorReadable(e);\n\t\t\t\t\treturn Promise.reject(e);\n\t\t\t\t}\n\t\t\t}\n\t\t}, transformer.writableStrategy);\n\n\t\tthis.readable = new ReadableStream(<Source <R>> {\n\t\t\tstart(controller: ReadableStreamController<R>): Promise<void> {\n\t\t\t\tenqueueInReadable = controller.enqueue.bind(controller);\n\t\t\t\tcloseReadable = controller.close.bind(controller);\n\t\t\t\terrorReadable = controller.error.bind(controller);\n\t\t\t\treturn Promise.resolve();\n\t\t\t},\n\n\t\t\tpull(controller: ReadableStreamController<R>): Promise<void> {\n\t\t\t\tif (chunkWrittenButNotYetTransformed) {\n\t\t\t\t\tmaybeDoTransform();\n\t\t\t\t}\n\t\t\t\treturn Promise.resolve();\n\t\t\t},\n\n\t\t\tcancel(): Promise<void> {\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\t\t}, transformer.readableStrategy);\n\t}\n}\n"]}