{"version":3,"file":"queue.js","sourceRoot":"","sources":["queue.ts"],"names":["executeTask","getQueueHandle","queueTask"],"mappings":"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","sourcesContent":["import global from './global';\nimport { Handle } from './interfaces';\nimport has, { add as hasAdd } from './has';\n\nhasAdd('microtasks', (has('promise') || has('host-node') || has('dom-mutationobserver')));\n\nfunction executeTask(item: QueueItem): void {\n\tif (item.isActive) {\n\t\titem.callback();\n\t}\n}\n\nfunction getQueueHandle(item: QueueItem, destructor?: (...args: any[]) => any): Handle {\n\treturn {\n\t\tdestroy: function () {\n\t\t\tthis.destroy = function () {};\n\t\t\titem.isActive = false;\n\t\t\titem.callback = null;\n\n\t\t\tif (destructor) {\n\t\t\t\tdestructor();\n\t\t\t}\n\t\t}\n\t};\n}\n\ninterface PostMessageEvent extends Event {\n\tsource: any;\n\tdata: string;\n}\n\nexport interface QueueItem {\n\tisActive: boolean;\n\tcallback: (...args: any[]) => any;\n}\n\n// When no mechanism for registering microtasks is exposed by the environment,\n// microtasks will be queued and then executed in a single macrotask before the other\n// macrotasks are executed.\nlet checkMicroTaskQueue: () => void;\nlet microTasks: QueueItem[];\nif (!has('microtasks')) {\n\tlet isMicroTaskQueued: boolean = false;\n\n\tmicroTasks = [];\n\tcheckMicroTaskQueue = function (): void {\n\t\tif (!isMicroTaskQueued) {\n\t\t\tisMicroTaskQueued = true;\n\t\t\tqueueTask(function () {\n\t\t\t\tisMicroTaskQueued = false;\n\n\t\t\t\tif (microTasks.length) {\n\t\t\t\t\tlet item: QueueItem;\n\t\t\t\t\twhile (item = microTasks.shift()) {\n\t\t\t\t\t\texecuteTask(item);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n\nexport let queueTask = (function() {\n\tlet enqueue: (item: QueueItem) => void;\n\tlet destructor: (...args: any[]) => any;\n\n\t// Since the IE implementation of `setImmediate` is not flawless, we will test for\n\t// `postMessage` first.\n\tif (has('postmessage')) {\n\t\tlet queue: QueueItem[] = [];\n\n\t\tglobal.addEventListener('message', function (event: PostMessageEvent): void {\n\t\t\t// Confirm that the event was triggered by the current window and by this particular implementation.\n\t\t\tif (event.source === global && event.data === 'dojo-queue-message') {\n\t\t\t\tevent.stopPropagation();\n\n\t\t\t\tif (queue.length) {\n\t\t\t\t\texecuteTask(queue.shift());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tenqueue = function (item: QueueItem): void {\n\t\t\tqueue.push(item);\n\t\t\tglobal.postMessage('dojo-queue-message', '*');\n\t\t};\n\t}\n\telse if (has('setimmediate')) {\n\t\tdestructor = global.clearImmediate;\n\t\tenqueue = function (item: QueueItem): any {\n\t\t\treturn setImmediate(executeTask.bind(null, item));\n\t\t};\n\t}\n\telse {\n\t\tdestructor = global.clearTimeout;\n\t\tenqueue = function (item: QueueItem): any {\n\t\t\treturn setTimeout(executeTask.bind(null, item), 0);\n\t\t};\n\t}\n\n\tfunction queueTask(callback: (...args: any[]) => any): Handle {\n\t\tlet item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tlet id: any = enqueue(item);\n\n\t\treturn getQueueHandle(item, destructor && function () {\n\t\t\tdestructor(id);\n\t\t});\n\t};\n\n\t// TODO: Use aspect.before when it is available.\n\treturn has('microtasks') ? queueTask : function (callback: (...args: any[]) => any): Handle {\n\t\tcheckMicroTaskQueue();\n\t\treturn queueTask(callback);\n\t};\n})();\n\n/**\n * Since requestAnimationFrame's behavior does not match that expected from `queueTask`, it is not used there.\n * However, at times it makes more sense to delegate to requestAnimationFrame; hence the following method.\n */\nexport let queueAnimationTask = (function () {\n\tif (!has('raf')) {\n\t\treturn queueTask;\n\t}\n\n\treturn function (callback: (...args: any[]) => any): Handle {\n\t\tlet item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tlet rafId: number = requestAnimationFrame(executeTask.bind(null, item));\n\n\t\treturn getQueueHandle(item, function () {\n\t\t\tcancelAnimationFrame(rafId);\n\t\t});\n\t};\n})();\n\nexport let queueMicroTask = (function () {\n\tlet enqueue: (item: QueueItem) => void;\n\n\tif (has('promise')) {\n\t\tenqueue = function (item: QueueItem): void {\n\t\t\tglobal.Promise.resolve(item).then(executeTask);\n\t\t};\n\t}\n\telse if (has('host-node')) {\n\t\tenqueue = function (item: QueueItem): void {\n\t\t\tglobal.process.nextTick(executeTask.bind(null, item));\n\t\t};\n\t}\n\telse if (has('dom-mutationobserver')) {\n\t\tlet HostMutationObserver = global.MutationObserver || global.WebKitMutationObserver;\n\t\tlet queue: QueueItem[] = [];\n\t\tlet node = document.createElement('div');\n\t\tlet observer = new HostMutationObserver(function (): void {\n\t\t\tconst item: QueueItem = queue.length && queue.shift();\n\n\t\t\tif (item && item.isActive) {\n\t\t\t\titem.callback();\n\t\t\t}\n\t\t});\n\n\t\tobserver.observe(node, { attributes: true });\n\n\t\tenqueue = function (item: QueueItem): void {\n\t\t\tqueue.push(item);\n\t\t\tnode.setAttribute('queueStatus', '1');\n\t\t};\n\t}\n\telse {\n\t\tenqueue = function (item: QueueItem): void {\n\t\t\tcheckMicroTaskQueue();\n\t\t\tmicroTasks.push(item);\n\t\t};\n\t}\n\n\treturn function (callback: (...args: any[]) => any): Handle {\n\t\tlet item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tenqueue(item);\n\n\t\treturn getQueueHandle(item);\n\t};\n})();\n"]}